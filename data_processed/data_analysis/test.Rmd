---
title: "test"
author: "Alexander Marquard / 11779957"
date: "4 3 2022"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(feasts)
library(gridExtra)
library(mgcv)
library(forecast)
```

```{r prep}
final_df <- readRDS("../final_df.RDS")
impfungen <- readRDS("../../data_truth/RKI/impfungen.Rds")

N <- sum(unique(final_df$population))
```

```{r}
total_gam <- gam(Hospitalisierung ~ Neuerkrankung * Altersgruppe +
                 s(Kalenderwoche, bs = "cc", k = 53) +
                 s(index, bs = "ps", by = Altersgruppe, k = 50),
               data = final_df,
               family = poisson(link = "log"),
               knots = list(Kalenderwoche = c(0.5, 53.5)))
summary(total_gam)
gam.check(total_gam)
plot(nordr_wf_gam)
auto.arima(residuals(nordr_wf_gam$gam))

```

```{r}
p_rate_ts <- final_df %>%
  group_by(Kalenderjahr, Kalenderwoche) %>%
  summarise(Hospitalisierung = sum(Hospitalisierung), 
            Neuerkrankung = sum(Neuerkrankung)) %>%
  mutate(hosprate = Hospitalisierung/N * 100000) %>%
  ungroup() %>% 
  select(hosprate) %>%
  as.ts()

aa <- auto.arima(p_rate_ts)
aa
res_ar <- arima(p_rate_ts, order = c(1,0,1))
p_test_fitted <- p_rate_ts - residuals(res_ar) 
ts.plot(p_rate_ts)
points(p_test_fitted, type = "l", col = 2, lty = 2)
autoplot(forecast(aa)) + theme_minimal()
forecast(aa)




p_rate_train <- final_df %>%
  group_by(Kalenderjahr, Kalenderwoche) %>%
  summarise(Hospitalisierung = sum(Hospitalisierung), 
            Neuerkrankung = sum(Neuerkrankung)) %>%
  mutate(hosprate = Hospitalisierung/(Neuerkrankung + 1)) %>%
  ungroup() %>% 
  select(hosprate) %>% 
  as.ts()

p_rate_test <- p_rate_train

p_rate_train <- as.ts(p_rate_train[-c(107,108)])
p_rate_test <- p_rate_test[c(107,108)]
aa <- auto.arima(p_rate_train, seasonal = F)
aa
res_ar <- arima(p_rate_train, order = c(2,1,3))
p_test_fitted <- p_rate_train - residuals(res_ar) 
ts.plot(p_rate_train)
points(p_test_fitted, type = "l", col = 2, lty = 2)
autoplot(forecast(aa)) + theme_minimal()
forecast(aa)

w <- forecast(aa, h = 2)
res <- matrix(nrow = 2, ncol = 2)
res[1,] <- c(p_rate_test[1], w$mean[1])
res[2,] <- c(p_rate_test[2], w$mean[2])
colnames(res) <- c("True", "Predicted")
rownames(res) <- c("107", "108")
res
```
