---
title: "test"
author: "Alexander Marquard / 11779957"
date: "4 3 2022"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(feasts)
library(gridExtra)
library(mgcv)
library(forecast)
```

```{r prep}
final_df <- readRDS("../final_df.RDS")
impfungen <- readRDS("../../data_truth/RKI/impfungen.Rds")

N <- sum(unique(final_df$population))
```
## Exponentielles GlÃ¤tten

```{r}
p_ets <- final_df %>%
  group_by(Meldedatum) %>%
  summarise(Hospitalisierung = sum(Hospitalisierung))

n <- nrow(p_ets)
aa <- list()
for (i in 0:10) {
  erg <- ets(as.ts(p_ets$Hospitalisierung[-(n - 10 + i: n)]), model = "AAN")
  aa[["plots"]][[as.character(i)]] <- autoplot(forecast(erg, h = 2)) + theme_minimal()
  aa[["erg"]][[as.character(i)]] <- forecast(erg, h = 2)
}
ggplot() +
  geom_ribbon(data = as.data.frame(aa$erg$`0`), 
            aes(x = as.numeric(rownames(as.data.frame(aa$erg$`0`))), 
                ymin = `Lo 95`, ymax = `Hi 95`), fill = "grey75") +
  geom_line(data = as.data.frame(aa$erg$`0`), 
            aes(x = as.numeric(rownames(as.data.frame(aa$erg$`0`))),
                  y = `Point Forecast`), col = "blue") +
  geom_ribbon(data = as.data.frame(aa$erg$`1`), 
            aes(x = as.numeric(rownames(as.data.frame(aa$erg$`1`))), 
                ymin = `Lo 95`, ymax = `Hi 95`), fill = "grey75") +
  geom_line(data = as.data.frame(aa$erg$`1`), 
            aes(x = as.numeric(rownames(as.data.frame(aa$erg$`1`))),
                  y = `Point Forecast`), col = "blue") +
  geom_ribbon(data = as.data.frame(aa$erg$`2`), 
            aes(x = as.numeric(rownames(as.data.frame(aa$erg$`2`))), 
                ymin = `Lo 95`, ymax = `Hi 95`), fill = "grey75") +
  geom_line(data = as.data.frame(aa$erg$`2`), 
            aes(x = as.numeric(rownames(as.data.frame(aa$erg$`2`))),
                  y = `Point Forecast`), col = "blue") +
  geom_ribbon(data = as.data.frame(aa$erg$`3`), 
            aes(x = as.numeric(rownames(as.data.frame(aa$erg$`3`))), 
                ymin = `Lo 95`, ymax = `Hi 95`), fill = "grey75") +
  geom_line(data = as.data.frame(aa$erg$`3`), 
            aes(x = as.numeric(rownames(as.data.frame(aa$erg$`3`))),
                  y = `Point Forecast`), col = "blue") +
  geom_ribbon(data = as.data.frame(aa$erg$`4`), 
            aes(x = as.numeric(rownames(as.data.frame(aa$erg$`4`))), 
                ymin = `Lo 95`, ymax = `Hi 95`), fill = "grey75") +
  geom_line(data = as.data.frame(aa$erg$`4`), 
            aes(x = as.numeric(rownames(as.data.frame(aa$erg$`4`))),
                  y = `Point Forecast`), col = "blue") +
  geom_ribbon(data = as.data.frame(aa$erg$`5`), 
            aes(x = as.numeric(rownames(as.data.frame(aa$erg$`5`))), 
                ymin = `Lo 95`, ymax = `Hi 95`), fill = "grey75") +
  geom_line(data = as.data.frame(aa$erg$`5`), 
            aes(x = as.numeric(rownames(as.data.frame(aa$erg$`5`))),
                  y = `Point Forecast`), col = "blue") +
  geom_ribbon(data = as.data.frame(aa$erg$`6`), 
            aes(x = as.numeric(rownames(as.data.frame(aa$erg$`6`))), 
                ymin = `Lo 95`, ymax = `Hi 95`), fill = "grey75") +
  geom_line(data = as.data.frame(aa$erg$`6`), 
            aes(x = as.numeric(rownames(as.data.frame(aa$erg$`6`))),
                  y = `Point Forecast`), col = "blue") +
  geom_ribbon(data = as.data.frame(aa$erg$`7`), 
            aes(x = as.numeric(rownames(as.data.frame(aa$erg$`7`))), 
                ymin = `Lo 95`, ymax = `Hi 95`), fill = "grey75") +
  geom_line(data = as.data.frame(aa$erg$`7`), 
            aes(x = as.numeric(rownames(as.data.frame(aa$erg$`7`))),
                  y = `Point Forecast`), col = "blue") +
  geom_ribbon(data = as.data.frame(aa$erg$`8`), 
            aes(x = as.numeric(rownames(as.data.frame(aa$erg$`8`))), 
                ymin = `Lo 95`, ymax = `Hi 95`), fill = "grey75") +
  geom_line(data = as.data.frame(aa$erg$`8`), 
            aes(x = as.numeric(rownames(as.data.frame(aa$erg$`8`))),
                  y = `Point Forecast`), col = "blue") +
  geom_ribbon(data = as.data.frame(aa$erg$`9`), 
            aes(x = as.numeric(rownames(as.data.frame(aa$erg$`9`))), 
                ymin = `Lo 95`, ymax = `Hi 95`), fill = "grey75") +
  geom_line(data = as.data.frame(aa$erg$`9`), 
            aes(x = as.numeric(rownames(as.data.frame(aa$erg$`9`))),
                  y = `Point Forecast`), col = "blue") +
  geom_ribbon(data = as.data.frame(aa$erg$`10`), 
            aes(x = as.numeric(rownames(as.data.frame(aa$erg$`10`))), 
                ymin = `Lo 95`, ymax = `Hi 95`), fill = "grey75") +
  geom_line(data = as.data.frame(aa$erg$`10`), 
            aes(x = as.numeric(rownames(as.data.frame(aa$erg$`10`))),
                  y = `Point Forecast`), col = "blue") +
  geom_line(data = p_ets, aes(x=1:nrow(p_ets), y = Hospitalisierung)) +
  xlab("Zeit") +
  ylab("Hospitalisierung") +
  theme_minimal()

```

## Exponential Smoothing mit Hosp/Infekt

```{r}
p_hosp_inf <- final_df %>%
  group_by(Meldedatum) %>%
  summarise(Hospitalisierung = sum(Hospitalisierung),
            Neuerkrankung = sum(Neuerkrankung)) %>%
  mutate(hosprate = Hospitalisierung / (Neuerkrankung + 1))

n <- nrow(p_hosp_inf)
aa <- list()
for (i in 0:10) {
  erg <- ets(as.ts(p_hosp_inf$hosprate[-(n - 10 + i: n)]), model = "ZZN")
  aa[["plots"]][[as.character(i)]] <- autoplot(forecast(erg, h = 2)) + theme_minimal()
  aa[["erg"]][[as.character(i)]] <- forecast(erg, h = 2)
}

ggplot() +
  geom_ribbon(data = as.data.frame(aa$erg$`0`), 
            aes(x = as.numeric(rownames(as.data.frame(aa$erg$`0`))), 
                ymin = `Lo 95`, ymax = `Hi 95`), fill = "grey75") +
  geom_line(data = as.data.frame(aa$erg$`0`), 
            aes(x = as.numeric(rownames(as.data.frame(aa$erg$`0`))),
                  y = `Point Forecast`), col = "blue") +
  geom_ribbon(data = as.data.frame(aa$erg$`1`), 
            aes(x = as.numeric(rownames(as.data.frame(aa$erg$`1`))), 
                ymin = `Lo 95`, ymax = `Hi 95`), fill = "grey75") +
  geom_line(data = as.data.frame(aa$erg$`1`), 
            aes(x = as.numeric(rownames(as.data.frame(aa$erg$`1`))),
                  y = `Point Forecast`), col = "blue") +
  geom_ribbon(data = as.data.frame(aa$erg$`2`), 
            aes(x = as.numeric(rownames(as.data.frame(aa$erg$`2`))), 
                ymin = `Lo 95`, ymax = `Hi 95`), fill = "grey75") +
  geom_line(data = as.data.frame(aa$erg$`2`), 
            aes(x = as.numeric(rownames(as.data.frame(aa$erg$`2`))),
                  y = `Point Forecast`), col = "blue") +
  geom_ribbon(data = as.data.frame(aa$erg$`3`), 
            aes(x = as.numeric(rownames(as.data.frame(aa$erg$`3`))), 
                ymin = `Lo 95`, ymax = `Hi 95`), fill = "grey75") +
  geom_line(data = as.data.frame(aa$erg$`3`), 
            aes(x = as.numeric(rownames(as.data.frame(aa$erg$`3`))),
                  y = `Point Forecast`), col = "blue") +
  geom_ribbon(data = as.data.frame(aa$erg$`4`), 
            aes(x = as.numeric(rownames(as.data.frame(aa$erg$`4`))), 
                ymin = `Lo 95`, ymax = `Hi 95`), fill = "grey75") +
  geom_line(data = as.data.frame(aa$erg$`4`), 
            aes(x = as.numeric(rownames(as.data.frame(aa$erg$`4`))),
                  y = `Point Forecast`), col = "blue") +
  geom_ribbon(data = as.data.frame(aa$erg$`5`), 
            aes(x = as.numeric(rownames(as.data.frame(aa$erg$`5`))), 
                ymin = `Lo 95`, ymax = `Hi 95`), fill = "grey75") +
  geom_line(data = as.data.frame(aa$erg$`5`), 
            aes(x = as.numeric(rownames(as.data.frame(aa$erg$`5`))),
                  y = `Point Forecast`), col = "blue") +
  geom_ribbon(data = as.data.frame(aa$erg$`6`), 
            aes(x = as.numeric(rownames(as.data.frame(aa$erg$`6`))), 
                ymin = `Lo 95`, ymax = `Hi 95`), fill = "grey75") +
  geom_line(data = as.data.frame(aa$erg$`6`), 
            aes(x = as.numeric(rownames(as.data.frame(aa$erg$`6`))),
                  y = `Point Forecast`), col = "blue") +
  geom_ribbon(data = as.data.frame(aa$erg$`7`), 
            aes(x = as.numeric(rownames(as.data.frame(aa$erg$`7`))), 
                ymin = `Lo 95`, ymax = `Hi 95`), fill = "grey75") +
  geom_line(data = as.data.frame(aa$erg$`7`), 
            aes(x = as.numeric(rownames(as.data.frame(aa$erg$`7`))),
                  y = `Point Forecast`), col = "blue") +
  geom_ribbon(data = as.data.frame(aa$erg$`8`), 
            aes(x = as.numeric(rownames(as.data.frame(aa$erg$`8`))), 
                ymin = `Lo 95`, ymax = `Hi 95`), fill = "grey75") +
  geom_line(data = as.data.frame(aa$erg$`8`), 
            aes(x = as.numeric(rownames(as.data.frame(aa$erg$`8`))),
                  y = `Point Forecast`), col = "blue") +
  geom_ribbon(data = as.data.frame(aa$erg$`9`), 
            aes(x = as.numeric(rownames(as.data.frame(aa$erg$`9`))), 
                ymin = `Lo 95`, ymax = `Hi 95`), fill = "grey75") +
  geom_line(data = as.data.frame(aa$erg$`9`), 
            aes(x = as.numeric(rownames(as.data.frame(aa$erg$`9`))),
                  y = `Point Forecast`), col = "blue") +
  geom_ribbon(data = as.data.frame(aa$erg$`10`), 
            aes(x = as.numeric(rownames(as.data.frame(aa$erg$`10`))), 
                ymin = `Lo 95`, ymax = `Hi 95`), fill = "grey75") +
  geom_line(data = as.data.frame(aa$erg$`10`), 
            aes(x = as.numeric(rownames(as.data.frame(aa$erg$`10`))),
                  y = `Point Forecast`), col = "blue") +
  geom_line(data = p_hosp_inf, aes(x=1:nrow(p_hosp_inf), y = hosprate)) +
  xlab("Zeit") +
  ylab("Hospitalisierung") +
  theme_minimal()
```

## GAM
```{r}
p_pop <- final_df %>%
  group_by(Meldedatum, Altersgruppe, Kalenderwoche, Kalenderjahr) %>%
  summarise(Hospitalisierung = sum(Hospitalisierung),
            Neuerkrankung = sum(Neuerkrankung)) %>%
  group_by(Altersgruppe) %>%
  arrange(Meldedatum) %>%
  mutate(index = row_number(Altersgruppe))

total_gam <- gam(Hospitalisierung ~ Neuerkrankung * Altersgruppe +
                 s(Kalenderwoche, bs = "cc", k = 53) +
                 s(index, bs = "ps", by = Altersgruppe, k = 50),
               data = p_pop,
               family = poisson(link = "log"),
               knots = list(Kalenderwoche = c(0.5, 53.5)))
summary(total_gam)
gam.check(total_gam)
plot(total_gam)
auto.arima(residuals(nordr_wf_gam$gam))

```

```{r forecasting}

diagnosis_df <- data.frame(mape = numeric(12), iteration = numeric(12))
forecast_res <- data.frame(Meldedatum = character(12), 
                           Hosp_one_week = numeric(12), 
                           Hosp_two_week = numeric(12))

for (i in seq(0, 1)) {
  train_df <- p_pop[1: ((98 + i)*6),]
  test_df <- p_pop[((98 + i) * 6 + 1):((100 + i)*6),]
  gam_train <- gam(Hospitalisierung ~ Neuerkrankung * Altersgruppe +
                 s(Kalenderwoche, bs = "cc", k = 53) +
                 s(index, bs = "ps", by = Altersgruppe, k = 50),
               data = train_df,
               family = poisson(link = "log"),
               knots = list(Kalenderwoche = c(0.5, 53.5)))
  
  forecast_l <- cbind(test_df, predict(gam_train, newdata = test_df, type = "response", se.fit = T))
  diagnosis_df$mape[i+1] <- MAPE(forecast_l$Hospitalisierung, forecast_l$fit)
  diagnosis_df$iteration[i+1] <- i+1
  forecast <- forecast_l %>% group_by(Meldedatum) %>%
    summarise(Hospitalisierung = sum(fit))
  forecast_res$Meldedatum[i + 1] <- as.character(forecast$Meldedatum[1])
  forecast_res$Meldedatum[i + 2] <- as.character(forecast$Meldedatum[2])
  forecast_res$Hosp_one_week[i + 1] <- forecast$Hospitalisierung[1]
  forecast_res$Hosp_two_week[i + 2] <- forecast$Hospitalisierung[2]
}
forecast_res$Meldedatum <- as.Date(forecast_res$Meldedatum, format = "%Y-%m-%d")
ggplot() +
  geom_line(data = p_pop %>% 
              group_by(Meldedatum) %>% 
              summarise(Hospitalisierung = sum(Hospitalisierung)), 
            aes(x = Meldedatum, y = Hospitalisierung)) +
  geom_line(data = forecast_res, aes(x = Meldedatum, y = Hosp_one_week, col = "red")) +
  geom_line(data = forecast_res, aes(x = Meldedatum, y = Hosp_two_week, col = "yellow"))

forecast_res
p_pop %>% 
              group_by(Meldedatum) %>% 
              summarise(Hospitalisierung = sum(Hospitalisierung)) %>% tail(20)
```





```{r}
p_rate_ts <- final_df %>%
  group_by(Kalenderjahr, Kalenderwoche) %>%
  summarise(Hospitalisierung = sum(Hospitalisierung), 
            Neuerkrankung = sum(Neuerkrankung)) %>%
  mutate(hosprate = Hospitalisierung/N * 100000) %>%
  ungroup() %>% 
  select(hosprate) %>%
  as.ts()

aa <- auto.arima(p_rate_ts)
aa
res_ar <- arima(p_rate_ts, order = c(1,0,1))
p_test_fitted <- p_rate_ts - residuals(res_ar) 
ts.plot(p_rate_ts)
points(p_test_fitted, type = "l", col = 2, lty = 2)
autoplot(forecast(aa)) + theme_minimal()
forecast(aa)




p_rate_train <- final_df %>%
  group_by(Kalenderjahr, Kalenderwoche) %>%
  summarise(Hospitalisierung = sum(Hospitalisierung), 
            Neuerkrankung = sum(Neuerkrankung)) %>%
  mutate(hosprate = Hospitalisierung/(Neuerkrankung + 1)) %>%
  ungroup() %>% 
  select(hosprate) %>% 
  as.ts()

p_rate_test <- p_rate_train

p_rate_train <- as.ts(p_rate_train[-c(107,108)])
p_rate_test <- p_rate_test[c(107,108)]
aa <- auto.arima(p_rate_train, seasonal = F)
aa
res_ar <- arima(p_rate_train, order = c(2,1,3))
p_test_fitted <- p_rate_train - residuals(res_ar) 
ts.plot(p_rate_train)
points(p_test_fitted, type = "l", col = 2, lty = 2)
autoplot(forecast(aa)) + theme_minimal()
forecast(aa)

w <- forecast(aa, h = 2)
res <- matrix(nrow = 2, ncol = 2)
res[1,] <- c(p_rate_test[1], w$mean[1])
res[2,] <- c(p_rate_test[2], w$mean[2])
colnames(res) <- c("True", "Predicted")
rownames(res) <- c("107", "108")
res
```
