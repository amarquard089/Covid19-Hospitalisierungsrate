---
title: "test"
author: "Alexander Marquard / 11779957"
date: "4 3 2022"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(feasts)
library(gridExtra)
library(mgcv)
library(forecast)
```

```{r prep}
final_df <- readRDS("../final_df.RDS")
impfungen <- readRDS("../../data_truth/RKI/impfungen.Rds")

N <- sum(unique(final_df$population))
```

## GAM
```{r}
p_pop <- final_df %>%
  group_by(Meldedatum, Altersgruppe, Kalenderwoche, Kalenderjahr) %>%
  summarise(Hospitalisierung = sum(Hospitalisierung),
            Neuerkrankung = sum(Neuerkrankung),
            population = sum(population)) %>%
  group_by(Altersgruppe) %>%
  arrange(Meldedatum) %>%
  mutate(index = row_number(Altersgruppe))


p_pop %>% group_by(Altersgruppe) %>% summarise(mean(Hospitalisierung), var(Hospitalisierung))

p_pop_train <- p_pop[1:642,]
p_pop_test <- p_pop[643:654,]

total_gam <- gam(Hospitalisierung ~ Neuerkrankung * Altersgruppe + 
                   s(index, bs = "ps", k = 50, by = Altersgruppe),
               data = p_pop_train,
               family = "quasipoisson",
               knots = list(Kalenderwoche = c(1, 53)))

p_pop_train <- cbind(p_pop_train, fitted = fitted(total_gam, type = "response"))
ggplot(p_pop_train) +
  geom_line(aes(x = Meldedatum, y = Hospitalisierung)) + 
  geom_line(aes(x = Meldedatum, y = fitted), col = "red") +
  facet_wrap(~Altersgruppe) + theme_minimal()


predict(total_gam, newdata = p_pop_test, type = "response")
p_pop_test$Hospitalisierung
summary(total_gam)
gam.check(total_gam)
plot(total_gam)
auto.arima(residuals(total_gam))
```

```{r forecasting}

diagnosis_df <- data.frame(mape = numeric(12), iteration = numeric(12))
forecast_res <- data.frame(Meldedatum = character(12), 
                           Hosp_one_week = numeric(12), 
                           Hosp_two_week = numeric(12))

for (i in seq(0, 1)) {
  train_df <- p_pop[1: ((98 + i)*6),]
  test_df <- p_pop[((98 + i) * 6 + 1):((100 + i)*6),]
  gam_train <- gamm(Hospitalisierung ~ Neuerkrankung * Altersgruppe * Kalenderjahr +
                 s(Kalenderwoche, bs = "cc", k = 53, by = Altersgruppe),
               data = train_df,
               family = poisson(link = "log"),
               knots = list(Kalenderwoche = c(0.5, 53.5)),
               random = list(Altersgruppe = ~1|Altersgruppe))
  
  forecast_l <- cbind(test_df, predict(gam_train$gam, newdata = test_df, type = "response", se.fit = T))
  diagnosis_df$mape[i+1] <- MAPE(forecast_l$Hospitalisierung, forecast_l$fit)
  diagnosis_df$iteration[i+1] <- i+1
  forecast <- forecast_l %>% group_by(Meldedatum) %>%
    summarise(Hospitalisierung = sum(fit))
  forecast_res$Meldedatum[i + 1] <- as.character(forecast$Meldedatum[1])
  forecast_res$Meldedatum[i + 2] <- as.character(forecast$Meldedatum[2])
  forecast_res$Hosp_one_week[i + 1] <- forecast$Hospitalisierung[1]
  forecast_res$Hosp_two_week[i + 2] <- forecast$Hospitalisierung[2]
}
forecast_res$Meldedatum <- as.Date(forecast_res$Meldedatum, format = "%Y-%m-%d")
ggplot() +
  geom_line(data = p_pop %>% 
              group_by(Meldedatum) %>% 
              summarise(Hospitalisierung = sum(Hospitalisierung)), 
            aes(x = Meldedatum, y = Hospitalisierung)) +
  geom_line(data = forecast_res, aes(x = Meldedatum, y = Hosp_one_week, col = "red")) +
  geom_line(data = forecast_res, aes(x = Meldedatum, y = Hosp_two_week, col = "yellow"))

forecast_res
p_pop %>% 
              group_by(Meldedatum) %>% 
              summarise(Hospitalisierung = sum(Hospitalisierung)) %>% tail(20)
```





```{r}
p_rate_ts <- final_df %>%
  group_by(Kalenderjahr, Kalenderwoche) %>%
  summarise(Hospitalisierung = sum(Hospitalisierung), 
            Neuerkrankung = sum(Neuerkrankung)) %>%
  mutate(hosprate = Hospitalisierung/N * 100000) %>%
  ungroup() %>% 
  select(hosprate) %>%
  as.ts()

aa <- auto.arima(p_rate_ts)
aa
res_ar <- arima(p_rate_ts, order = c(1,0,1))
p_test_fitted <- p_rate_ts - residuals(res_ar) 
ts.plot(p_rate_ts)
points(p_test_fitted, type = "l", col = 2, lty = 2)
autoplot(forecast(aa)) + theme_minimal()
forecast(aa)




p_rate_train <- final_df %>%
  group_by(Kalenderjahr, Kalenderwoche) %>%
  summarise(Hospitalisierung = sum(Hospitalisierung), 
            Neuerkrankung = sum(Neuerkrankung)) %>%
  mutate(hosprate = Hospitalisierung/(Neuerkrankung + 1)) %>%
  ungroup() %>% 
  select(hosprate) %>% 
  as.ts()

p_rate_test <- p_rate_train

p_rate_train <- as.ts(p_rate_train[-c(107,108)])
p_rate_test <- p_rate_test[c(107,108)]
aa <- auto.arima(p_rate_train, seasonal = F)
aa
res_ar <- arima(p_rate_train, order = c(2,1,3))
p_test_fitted <- p_rate_train - residuals(res_ar) 
ts.plot(p_rate_train)
points(p_test_fitted, type = "l", col = 2, lty = 2)
autoplot(forecast(aa)) + theme_minimal()
forecast(aa)

w <- forecast(aa, h = 2)
res <- matrix(nrow = 2, ncol = 2)
res[1,] <- c(p_rate_test[1], w$mean[1])
res[2,] <- c(p_rate_test[2], w$mean[2])
colnames(res) <- c("True", "Predicted")
rownames(res) <- c("107", "108")
res
```
