---
title: "qian_datensatzneu"
author: "Qian Feng"
date: "12/15/2021"
output: html_document
---
Einfach alle Chunks durchführen und "fin_datensatz" ist das finale datensatz. Wenn Sie wollen Altersgruppe und Bundesland in mehreren Kategorien sind, dann den letzten Chunk sehen.
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(tibble)
library(stringr)
library(readr)
library(tidyr)
library(lubridate)
library(tidyverse)
```

orignal Datensatz
```{r read data}
inzidenz <- readRDS('../data_truth/RKI/infektionen.Rds')

inzidenznowcasting <- read.csv('https://raw.githubusercontent.com/robert-koch-institut/SARS-CoV-2-Nowcasting_und_-R-Schaetzung/main/Nowcast_R_aktuell.csv')

hospitalisierung <- readRDS('../data_truth/RKI/hospitalisierung.Rds')

hospitalisierung_daily <- read.csv('https://raw.githubusercontent.com/KITmetricslab/hospitalization-nowcast-hub/main/data-truth/COVID-19/deconvoluted/2021-12-15_COVID-19_hospitalization_deconvoluted.csv')

hospitalisierungnowcasting <- readRDS('../data_truth/RKI/hospitalisierung_adjustiert.Rds')

impfung <- readRDS('../data_truth/RKI/impfungen.Rds')

bevoelkerung <- readRDS('../data_truth/KIT/kit_bevoelkerung.Rds')

Covid19_Regelungen <- readRDS('../data_truth/zusaetzlich/regelungen.Rds')

```

Data "inzidenz" nach Meldedatum cleaning
```{r inzidenz_meldedatum_clean}
# wechseln Bundeslandsnummer zu Bundeslandname
df_bundeslaender <- data.frame('Bundeslandnummer' = as.character(seq(16)), 
                                'Bundesland' = c("Schleswig-Holstein",
                                                      "Hamburg",
                                                      "Niedersachsen",
                                                      "Bremen",
                                                      "Nordrhein-Westfalen",
                                                      "Hessen",
                                                      "Rheinland-Pfalz",
                                                      "Baden-Wuerttemberg",
                                                      "Bayern",
                                                      "Saarland",
                                                      "Berlin",
                                                      "Brandenburg",
                                                      "Mecklenburg-Vorpommern",
                                                      "Sachsen",
                                                      "Sachsen-Anhalt",
                                                      "Thueringen")
)
inzidenz_new <-
  inzidenz %>%
  mutate(IdLandkreis = as.character(IdLandkreis)) %>%
  mutate(Bundeslandnummer = gsub('.{3}$', '', IdLandkreis))

inzidenz_new <- dplyr::left_join(inzidenz_new, df_bundeslaender, by = 'Bundeslandnummer')

inzidenz_meldedatum_clean <- 
  inzidenz_new %>%
  select(Meldedatum, Bundesland, Altersgruppe, Neuerkrankung = AnzahlFall) %>% 
  mutate(Meldedatum = as.Date(Meldedatum),
         Altersgruppe = str_remove_all(Altersgruppe, "A")) %>%
  mutate(Altersgruppe = case_when(
    Altersgruppe == "unbekannt" ~ NA_character_,
    TRUE ~ Altersgruppe
  )) %>%
  arrange(-desc(Meldedatum)) %>%
  group_by(Meldedatum, Bundesland, Altersgruppe) %>%
  summarise(Neuerkrankung = sum(Neuerkrankung)) %>%
  ungroup() %>%
  mutate(Altersgruppe = as.factor(Altersgruppe),
         Bundesland = as.factor(Bundesland)) %>%
  mutate(Kalenderjahr = format(Meldedatum, format = "%Y"),
         Kalenderwoche = strftime(Meldedatum, format = "%V")) %>%
  mutate(Kalenderjahr = replace(Kalenderjahr, Kalenderwoche == "53", "2020")) %>%
  filter(!(Kalenderjahr == "2021" & Kalenderwoche > "44")) %>%
  select(Kalenderjahr, Kalenderwoche, Bundesland, Altersgruppe, Neuerkrankung) %>%
  group_by(Kalenderjahr, Kalenderwoche, Bundesland, Altersgruppe) %>% 
  summarise(Neuerkrankung = sum(Neuerkrankung)) %>%
  ungroup() %>%
  na.omit() # Es gibt 8668 - 8226 = 442NAs
```

Data "hospitalisierung" cleaning
```{r hospitalisierung_clean}
# wenn man am 16.12.2021 untersuchen, dann ist Hospitalisierung bis 07.11.2021 fertig nachgemeldet und braucht keine Nowcasting.
# Sonntag, 07.11.2021 KW44, deswegen bleiben hier die tatsächlich Daten mit Nachmeldung bis KW44.
df_bundeslaender3 <- data.frame('location' = c("DE-SH", "DE-HH", "DE-NI", "DE-HB", "DE-NW", "DE-HE", "DE-RP", "DE-BW", "DE-BY", "DE-SL", "DE-BE", "DE-BB", "DE-MV", "DE-SN", "DE-ST", "DE-TH", "DE"),
                                'Bundesland' =
                                  c("Schleswig-Holstein",
                                    "Hamburg",
                                    "Niedersachsen",
                                    "Bremen",
                                    "Nordrhein-Westfalen",
                                    "Hessen",
                                    "Rheinland-Pfalz",
                                    "Baden-Wuerttemberg",
                                    "Bayern",
                                    "Saarland",
                                    "Berlin",
                                    "Brandenburg",
                                    "Mecklenburg-Vorpommern",
                                    "Sachsen",
                                    "Sachsen-Anhalt",
                                    "Thueringen",
                                    "Deutschland")
)
hospitalisierung_daily_new <- dplyr::left_join(hospitalisierung_daily, df_bundeslaender3, by = 'location')

hospitalisierung_clean <- 
  hospitalisierung_daily_new %>%
  mutate(Datum = as.Date(date),
         Hospitalisierung = value,
         Altersgruppe = as.factor(age_group),
         Bundesland = as.factor(Bundesland)) %>%
  filter(!(Bundesland == "Deutschland" | Altersgruppe == "00+")) %>%
  select(Datum, Bundesland, Altersgruppe, Hospitalisierung) %>%
  arrange(-desc(Datum)) %>%
  mutate(Kalenderjahr = format(Datum, format = "%Y"),
         Kalenderwoche = strftime(Datum, format = "%V")) %>%
  mutate(Kalenderjahr = replace(Kalenderjahr, Kalenderwoche == "53", "2020")) %>%
  filter(!(Kalenderjahr == "2021" & Kalenderwoche > "44")) %>%
  select(Kalenderjahr, Kalenderwoche, Bundesland, Altersgruppe, Hospitalisierung) %>%
  group_by(Kalenderjahr, Kalenderwoche, Bundesland, Altersgruppe) %>% 
  summarise(Hospitalisierung = sum(Hospitalisierung)) %>%
  ungroup() %>%
  na.omit() # Es gibt keine NAs.
```

Data "impfung" weekly cleaning
```{r impfung_clean_sum_weekly, echo = F, message=FALSE}
df_bundeslaender2 <- data.frame('Bundeslandnummer' = c("01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12", "13", "14", "15", "16", "17"), 
                                'Bundesland' = c("Schleswig-Holstein",
                                                      "Hamburg",
                                                      "Niedersachsen",
                                                      "Bremen",
                                                      "Nordrhein-Westfalen",
                                                      "Hessen",
                                                      "Rheinland-Pfalz",
                                                      "Baden-Wuerttemberg",
                                                      "Bayern",
                                                      "Saarland",
                                                      "Berlin",
                                                      "Brandenburg",
                                                      "Mecklenburg-Vorpommern",
                                                      "Sachsen",
                                                      "Sachsen-Anhalt",
                                                      "Thueringen",
                                                 "Bundesressorts")
)
impfung_new <-
  impfung %>%
  mutate(IdLandkreis = as.character(LandkreisId_Impfort)) %>%
  mutate(Bundeslandnummer = gsub('.{3}$', '', LandkreisId_Impfort))

impfung_new <- dplyr::left_join(impfung_new, df_bundeslaender2, by = 'Bundeslandnummer')

# Clean the Daten
impfung_clean <-
  impfung_new %>%
  select(Impfdatum, Bundesland, Altersgruppe, Impfschutz, Impfanzahl = Anzahl) %>% 
  mutate(Impfdatum = as.Date(Impfdatum),
         Impfschutz = as.factor(Impfschutz),
         Bundesland = as.factor(Bundesland),
         Altersgruppe = as.factor(Altersgruppe)) %>%
  arrange(-desc(Impfdatum)) %>%
  filter(Impfschutz == "2") %>%
  group_by(Impfdatum, Bundesland, Altersgruppe, Impfschutz) %>%
  summarise(Impfanzahl = sum(Impfanzahl)) %>%
  ungroup() %>%
  filter(Impfdatum <= "2021-11-28")

# 14 Tage nach zweiter Impfung kann man vollstaendig schutzt werden.
impfung_vollstaendig <-
  impfung_clean %>%
  mutate(Impfdatum = Impfdatum + 14) %>%
  arrange(-desc(Impfdatum))

# In originale Daten gibt es nur die Anzahl von Impften nur fuer einen Tag, hier kann man die die Anzahl von Impften nur fuer diesen Tag und vorher wissen.
date_begin <- as.Date("2021-01-10")
date_end <- as.Date("2021-12-12")
df_new2 <- data.frame()
  for (datum in date_begin:date_end) {
  df_new <- 
  impfung_vollstaendig %>%
  filter(Impfdatum <= datum)
  df_new <-
  df_new %>%
  add_column(add_Date = as.Date(datum, origin="1970-01-01")) %>%
  select(add_Date, Bundesland, Altersgruppe, Impfschutz, Impfanzahl) %>%
  group_by(add_Date, Bundesland, Altersgruppe, Impfschutz) %>%
  summarise(Impfanzahl = sum(Impfanzahl))
  df_new2 <- rbind(df_new, df_new2)
}

impfung_clean_sum_daily <-
  df_new2 %>%
  mutate(Datum = add_Date) %>%
  arrange(-desc(Datum)) %>%
  ungroup() %>%
  select(-c(add_Date, Impfschutz))

impfung_clean_sum_weekly <- 
  impfung_clean_sum_daily %>%
  select(Datum, Bundesland, Altersgruppe, Impfanzahl) %>% 
  arrange(-desc(Datum)) %>%
  mutate(Weekday = as.factor(weekdays(Datum, abbreviate = TRUE))) %>%
  filter(Weekday == "Sun") %>% # "Sonntag"
  mutate(Kalenderjahr = format(Datum, format = "%Y"),
         Kalenderwoche = strftime(Datum, format = "%V")) %>%
  mutate(Kalenderjahr = replace(Kalenderjahr, Kalenderwoche == "53", "2020")) %>%
  select(Kalenderjahr, Kalenderwoche, Bundesland, Altersgruppe, Impfanzahl)
```

Data "bevoelkerung" cleaning
```{r bevoelkerung_clean}
bevoelkerung_clean <-
  bevoelkerung %>%
  filter(!(location == "DE" | age_group == "00+")) %>%
  select(location, age_group, population) %>%
  mutate(Altersgruppe = as.factor(age_group),
         Bundesland = as.factor(location),
         Bevoelkerung = population) %>%
  select(Bundesland, Altersgruppe, Bevoelkerung) %>%
  mutate(Bundesland = str_replace_all(Bundesland, "ü", "ue")) %>% 
  mutate(Bundesland = str_replace_all(Bundesland, "ä", "ae")) %>% 
  mutate(Bundesland = str_replace_all(Bundesland, "ö", "oe")) %>% 
  mutate(Bundesland = str_replace_all(Bundesland, "ß", "ss"))
```

Zusammenfassung von inzidenz nach Anmeldedatum, Hospitalisierung, impfquote und Lockdown
```{r Zusammenfassung}
# Zusammenfassung von inzidenz nach Anmeldedatum und Hospitalisierung
inzidenzanmeldedatum_hosp <- merge(inzidenz_meldedatum_clean, hospitalisierung_clean, by = c("Kalenderjahr", "Kalenderwoche", "Bundesland", "Altersgruppe"), all = T)

# ersetzen NA durch 0 in column "Hospitalisierung" und "Neuerkrankung"
inzidenzanmeldedatum_hosp <-
  inzidenzanmeldedatum_hosp %>%
  mutate(Hospitalisierung = ifelse(is.na(Hospitalisierung), 0, Hospitalisierung),
         Neuerkrankung = ifelse(is.na(Neuerkrankung), 0, Neuerkrankung))

# add date und add season

# Column "Datum" ist der Tag von letzter Woche(der Datunm von dem Sonntag)
# Column "Jahreszeit": 
# Spring: March 21 to June 20
# Summer: June 21 to September 20
# Autumn: September 21 to December 20
# Winter: December 21 to March 20

# 2020

inzidenzanmeldedatum_hosp2020 <-
  inzidenzanmeldedatum_hosp %>%
  filter(Kalenderjahr == "2020") %>%
  add_column(Jahreszeit = case_when(
.$Kalenderwoche == "01" | .$Kalenderwoche == "02" | .$Kalenderwoche == "03" | .$Kalenderwoche == "04" | .$Kalenderwoche == "05" | .$Kalenderwoche == "06" | .$Kalenderwoche == "07" | .$Kalenderwoche == "08" | .$Kalenderwoche == "09" | .$Kalenderwoche == "10" | .$Kalenderwoche == "11" | .$Kalenderwoche == "12" | .$Kalenderwoche == "52" | .$Kalenderwoche == "53" ~ "Winter",
.$Kalenderwoche == "13" | .$Kalenderwoche == "14" | .$Kalenderwoche == "15" | .$Kalenderwoche == "16" | .$Kalenderwoche == "17" | .$Kalenderwoche == "18" | .$Kalenderwoche == "19" | .$Kalenderwoche == "20" | .$Kalenderwoche == "21" | .$Kalenderwoche == "22" | .$Kalenderwoche == "23" | .$Kalenderwoche == "24" | .$Kalenderwoche == "25" ~ "Fruehling",
.$Kalenderwoche == "26" | .$Kalenderwoche == "27" | .$Kalenderwoche == "28" | .$Kalenderwoche == "29" | .$Kalenderwoche == "30" | .$Kalenderwoche == "31" | .$Kalenderwoche == "32" | .$Kalenderwoche == "33" | .$Kalenderwoche == "34" | .$Kalenderwoche == "35" | .$Kalenderwoche == "36" | .$Kalenderwoche == "37" | .$Kalenderwoche == "38" ~ "Sommer",
.$Kalenderwoche == "39" | .$Kalenderwoche == "40" | .$Kalenderwoche == "41" | .$Kalenderwoche == "42" | .$Kalenderwoche == "43" | .$Kalenderwoche == "44" | .$Kalenderwoche == "45" | .$Kalenderwoche == "46" | .$Kalenderwoche == "47" | .$Kalenderwoche == "48" | .$Kalenderwoche == "49" | .$Kalenderwoche == "50" | .$Kalenderwoche == "51" ~ "Herbst")) %>%
  mutate(Zwischenelement = paste(Kalenderjahr, Kalenderwoche, "7", sep = '-')) %>%
  mutate(Datum = as.Date(Zwischenelement, format = "%Y-%U-%u")) %>%
  mutate(Datum = replace(Datum, Kalenderwoche == "53" & Kalenderjahr == "2020", "2021-01-03")) %>%
  select(-Zwischenelement)

# 2021

inzidenzanmeldedatum_hosp2021 <-
  inzidenzanmeldedatum_hosp %>%
  filter(Kalenderjahr == "2021") %>%
  add_column(Jahreszeit = case_when(
.$Kalenderwoche == "01" | .$Kalenderwoche == "02" | .$Kalenderwoche == "03" | .$Kalenderwoche == "04" | .$Kalenderwoche == "05" | .$Kalenderwoche == "06" | .$Kalenderwoche == "07" | .$Kalenderwoche == "08" | .$Kalenderwoche == "09" | .$Kalenderwoche == "10" | .$Kalenderwoche == "11" | .$Kalenderwoche == "51" | .$Kalenderwoche == "52" ~ "Winter",
.$Kalenderwoche == "12" | .$Kalenderwoche == "13" | .$Kalenderwoche == "14" | .$Kalenderwoche == "15" | .$Kalenderwoche == "16" | .$Kalenderwoche == "17" | .$Kalenderwoche == "18" | .$Kalenderwoche == "19" | .$Kalenderwoche == "20" | .$Kalenderwoche == "21" | .$Kalenderwoche == "22" | .$Kalenderwoche == "23" | .$Kalenderwoche == "24" ~ "Fruehling",
.$Kalenderwoche == "25" | .$Kalenderwoche == "26" | .$Kalenderwoche == "27" | .$Kalenderwoche == "28" | .$Kalenderwoche == "29" | .$Kalenderwoche == "30" | .$Kalenderwoche == "31" | .$Kalenderwoche == "32" | .$Kalenderwoche == "33" | .$Kalenderwoche == "34" | .$Kalenderwoche == "35" | .$Kalenderwoche == "36" | .$Kalenderwoche == "37" ~ "Sommer",
.$Kalenderwoche == "38" | .$Kalenderwoche == "39" | .$Kalenderwoche == "40" | .$Kalenderwoche == "41" | .$Kalenderwoche == "42" | .$Kalenderwoche == "43" | .$Kalenderwoche == "44" | .$Kalenderwoche == "45" | .$Kalenderwoche == "46" | .$Kalenderwoche == "47" | .$Kalenderwoche == "48" | .$Kalenderwoche == "49" | .$Kalenderwoche == "50" ~ "Herbst")) %>%
  mutate(Zwischenelement = paste(Kalenderjahr, Kalenderwoche, "7", sep = '-')) %>%
  mutate(Datum = as.Date(Zwischenelement, format = "%Y-%U-%u") + 7) %>%
  select(-Zwischenelement)

inzidenzanmeldedatum_hosp_jahreszeit_datum <- rbind(inzidenzanmeldedatum_hosp2020, inzidenzanmeldedatum_hosp2021)

# add Lockdown
Covid19_Regelungen_new <-
  Covid19_Regelungen %>%
  mutate(Kalenderjahr = as.character(Jahr),
         Kalenderwoche = as.character(KW),
         Lockdown = as.factor(Lockdown)) %>%
  select(Kalenderjahr, Kalenderwoche, Lockdown) %>%
  mutate(Kalenderwoche = case_when(
    Kalenderwoche == "1" ~ "01",
    Kalenderwoche == "2" ~ "02",
    Kalenderwoche == "3" ~ "03",
    Kalenderwoche == "4" ~ "04",
    Kalenderwoche == "5" ~ "05",
    Kalenderwoche == "6" ~ "06",
    Kalenderwoche == "7" ~ "07",
    Kalenderwoche == "8" ~ "08",
    Kalenderwoche == "9" ~ "09",
    TRUE ~ Kalenderwoche
    ))

fin_datensatz <-
  merge(inzidenzanmeldedatum_hosp_jahreszeit_datum, Covid19_Regelungen_new, by = c('Kalenderjahr', 'Kalenderwoche'), all.x = TRUE)

fin_datensatz <-
  fin_datensatz %>%
  select(Datum, Kalenderjahr, Kalenderwoche, Hospitalisierung, Neuerkrankung, Bundesland, Altersgruppe, Jahreszeit, Lockdown)
```

Altersgruppe und Bundesland in mehreren Kategorien
```{r Altersgruppe und Bundesland in mehreren Kategorien}
# Altersgruppe in mehreren Kategorien
list_of_altersgruppe <-
  split(fin_datensatz, fin_datensatz$Altersgruppe)
# Beispiel(wie man list_of_altersgruppe benutzen)
list_of_altersgruppe$`00-04`

# Bundesland in mehreren Kategorien
list_of_bundesland <-
  split(fin_datensatz, fin_datensatz$Bundesland)
# Beispiel(wie man list_of_bundesland benutzen)
list_of_bundesland$`Baden-Wuerttemberg`

# Altersgruppe und Bundesland in mehreren Kategorien
list_of_bundesland_altersgruppe <-
  split(fin_datensatz, list(fin_datensatz$Bundesland, fin_datensatz$Altersgruppe), drop = TRUE)
# Beispiel(wie man list_of_bundesland_altersgruppe benutzen)
list_of_bundesland_altersgruppe$`Hessen.05-14`
```