---
title: "datensatz"
author: "Qian Feng"
date: "2021/11/25"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(tibble)
library(stringr)
library(readr)
library(tidyr)
library(lubridate)
library(tidyverse)
```

orignal Datensatz
```{r}
# from: https://github.com/robert-koch-institut/SARS-CoV-2_Infektionen_in_Deutschland
# Aktuell_Deutschland_SarsCov2_Infektionen
inzidenz_link <- "https://media.githubusercontent.com/media/robert-koch-institut/SARS-CoV-2_Infektionen_in_Deutschland/master/Aktuell_Deutschland_SarsCov2_Infektionen.csv"
inzidenz <- read_csv(inzidenz_link, col_types = cols())


# from:https://github.com/robert-koch-institut/COVID-19-Hospitalisierungen_in_Deutschland
# Aktuell_Deutschland_COVID-19-Hospitalisierungen
hospitalisierung_link <- "https://raw.githubusercontent.com/robert-koch-institut/COVID-19-Hospitalisierungen_in_Deutschland/master/Aktuell_Deutschland_COVID-19-Hospitalisierungen.csv"
hospitalisierung <- read_csv(hospitalisierung_link, col_types = cols())

# Aktuell_Deutschland_adjustierte-COVID-19-Hospitalisierungen
hospitalisierungnowcasting_link <- "https://raw.githubusercontent.com/robert-koch-institut/COVID-19-Hospitalisierungen_in_Deutschland/master/Aktuell_Deutschland_adjustierte-COVID-19-Hospitalisierungen.csv"
hospitalisierungnowcasting <- read_csv(hospitalisierungnowcasting_link, col_types = cols())


# from: https://github.com/robert-koch-institut/COVID-19-Impfungen_in_Deutschland
# Aktuell_Deutschland_Landkreise_COVID-19-Impfungen
impfung_link <- "https://raw.githubusercontent.com/robert-koch-institut/COVID-19-Impfungen_in_Deutschland/master/Aktuell_Deutschland_Landkreise_COVID-19-Impfungen.csv"
impfung <- read_csv(impfung_link, col_types = cols())
```

```{r datenerfassung}
# tagesreport enthält informationen über covid fälle pro bundesland pro tag
divi_tagesreport <- readRDS('../daten/divi_tagesreport.Rds')

# Faelle_Hosp_Alter.Rds
Faelle_Hosp_Alter <- readRDS('../daten/Faelle_Hosp_Alter.Rds')

# inzidenz_impfstatus pro Woche
inzidenz_symptomatisch <- readRDS('../daten/inzidenz_symptom.Rds')
inzidenz_hospitalisiert <- readRDS('../daten/inzidenz_hosp.Rds')

# klinische_aspekte
klinische_aspekte <- readRDS('../daten/klinische_aspekte.Rds')

# nowcasting  pro tag
nowcasting_rki <- readRDS("../daten/nowcasting_rki.Rds")

# impfung pro tag + impfstoff
rki_impfung_nach_bl <- readRDS('../daten/rki_impfung_nach_bundesland.Rds')

# Sieben_Tage_Inzidenz_Hosp_Alter
Sieben_Tage_Inzidenz_Hosp_Alter <- readRDS("../daten/Sieben_Tage_Inzidenz_Hosp_Alter.Rds")


## Zusätzliche Daten

# bevölkerungsdichte deutschland Stand 31.12.2020
b_dichte <- readRDS('../daten/bevoelkerungsdichte.Rds')

```

Function
```{r}

```

Data "inzidenz" nach Meldedatum cleaning
```{r}
#summary(inzidenz)
# wechseln Bundeslandsnummer zu Bundeslandname
df_bundeslaender <- data.frame('Bundeslandnummer' = as.character(seq(16)), 
                                'Bundesland' = c("Schleswig-Holstein",
                                                      "Hamburg",
                                                      "Niedersachsen",
                                                      "Bremen",
                                                      "Nordrhein-Westfalen",
                                                      "Hessen",
                                                      "Rheinland-Pfalz",
                                                      "Baden-Wuerttemberg",
                                                      "Bayern",
                                                      "Saarland",
                                                      "Berlin",
                                                      "Brandenburg",
                                                      "Mecklenburg-Vorpommern",
                                                      "Sachsen",
                                                      "Sachen-Anhalt",
                                                      "Thueringen")
)
inzidenz_new <-
  inzidenz %>%
  mutate(IdLandkreis = as.character(IdLandkreis)) %>%
  mutate(Bundeslandnummer = gsub('.{3}$', '', IdLandkreis))

inzidenz_new <- dplyr::left_join(inzidenz_new, df_bundeslaender, by = 'Bundeslandnummer')

# Clean the Daten
inzidenz_clean <- 
  inzidenz_new %>%
  select(Bundesland, Altersgruppe, Geschlecht, Neuerkrankung = AnzahlFall, Meldedatum) %>% 
  mutate(Meldedatum = as.Date(Meldedatum)) %>%
  mutate(Altersgruppe = str_remove_all(Altersgruppe, "A")) %>% 
  mutate(Altersgruppe = case_when(
    Altersgruppe == "unbekannt" ~ NA_character_,
    TRUE ~ Altersgruppe
  )) %>% 
  mutate(Geschlecht = case_when(
    Geschlecht == "unbekannt" ~ NA_character_,
    TRUE ~ Geschlecht
  )) %>% 
  arrange(-desc(Meldedatum)) %>%
  mutate(Kalenderjahr = format(Meldedatum, format = "%Y"),
         Kalenderwoche = strftime(Meldedatum, format = "%V")) %>%
  relocate(c("Kalenderjahr", "Kalenderwoche", "Meldedatum", "Bundesland", "Altersgruppe", "Geschlecht", "Neuerkrankung"))

# 01.01.2021 bis 03.01.2021 gehoert zu 2020, Kalenderwoche 53
  inzidenz_clean_new <- inzidenz_clean %>%
    mutate(Kalenderjahr = replace(Kalenderjahr, Meldedatum == "2021-01-01", "2020")) %>%
    mutate(Kalenderjahr = replace(Kalenderjahr, Meldedatum == "2021-01-02", "2020")) %>%
    mutate(Kalenderjahr = replace(Kalenderjahr, Meldedatum == "2021-01-03", "2020")) %>%
  select(Kalenderjahr, Kalenderwoche, Bundesland, Altersgruppe, Geschlecht, Neuerkrankung) %>%
  group_by(Kalenderjahr, Kalenderwoche, Bundesland, Altersgruppe, Geschlecht) %>% 
  summarise(Neuerkrankung = sum(Neuerkrankung)) %>%
  ungroup()
```

untersuchen, ob Ergebnisse von "inzidenz_clean_new" gleich wie andere Daten von RKI sind(this chunk is not for Datensatz cleaning, just check, so when people don't have to run it, if they just want cleaned Datensatz)
```{r}
ggp <-
  inzidenz_clean %>%
  filter(Bundesland == "Berlin") %>%
  group_by(Meldedatum, Bundesland) %>% 
  summarise(Neuerkrankung = sum(Neuerkrankung)) %>% 
  ungroup() %>%
  ggplot() +
  aes(x = Meldedatum, y = Neuerkrankung) +
  geom_line()
  
 inzidenz_clean %>%
  filter(Bundesland == "Baden-Wuerttemberg" & Meldedatum == "2021-10-01") %>%
  group_by(Meldedatum, Bundesland) %>% 
  summarise(Neuerkrankung = sum(Neuerkrankung)) %>% 
  ungroup()
 
inzidenz_clean_new %>%
  #drop_na() %>%
  #filter(Kalenderjahr == "2021" & Kalenderwoche == "44") %>%
  select(Kalenderjahr, Kalenderwoche, Neuerkrankung) %>%
  group_by(Kalenderjahr, Kalenderwoche) %>% 
  summarise(Neuerkrankung = sum(Neuerkrankung)) %>% 
  ungroup()
```

changed inzidenz_clean_new(final version of inzidenz_clean_new)
```{r}
# 1. column "Geschlecht"
# 2. column "Geschlecht" veraendern: nur "00-59" und "60+"
# 3. "NA"-rows weg nehmen: es gibt 502 NAs.
# 4. filter Daten bis 2021/47
inzidenz_clean_final <-
  inzidenz_clean_new %>%
  select(Kalenderjahr, Kalenderwoche, Bundesland, Altersgruppe, Neuerkrankung) %>%
  mutate(Altersgruppe = case_when(
    Altersgruppe == "00-04" ~ "00-59",
    Altersgruppe == "05-14" ~ "00-59",
    Altersgruppe == "15-34" ~ "00-59",
    Altersgruppe == "35-59" ~ "00-59",
    Altersgruppe == "60-79" ~ "60+",
    Altersgruppe == "80+" ~ "60+",
    TRUE ~ Altersgruppe
  )) %>%
  group_by(Kalenderjahr, Kalenderwoche, Bundesland, Altersgruppe) %>%
  summarise(Neuerkrankung = sum(Neuerkrankung)) %>%
  ungroup() %>%
  na.omit() %>%
  filter(!(Kalenderjahr == "2021" & Kalenderwoche > "47"))

```

Data "inzidenz" nach Erkrankungsbeginn cleaning
```{r}
inzidenz_erkrankungsbeginn_clean <- 
  inzidenz_new %>%
  select(Bundesland, Altersgruppe, Geschlecht, Neuerkrankung = AnzahlFall, Refdatum) %>% 
  mutate(Erkrankungsdatum = as.Date(Refdatum)) %>%
  mutate(Altersgruppe = str_remove_all(Altersgruppe, "A")) %>% 
  mutate(Altersgruppe = case_when(
    Altersgruppe == "unbekannt" ~ NA_character_,
    TRUE ~ Altersgruppe
  )) %>% 
  mutate(Geschlecht = case_when(
    Geschlecht == "unbekannt" ~ NA_character_,
    TRUE ~ Geschlecht
  )) %>% 
  arrange(-desc(Erkrankungsdatum)) %>%
  mutate(Kalenderjahr = format(Erkrankungsdatum, format = "%Y"),
         Kalenderwoche = strftime(Erkrankungsdatum, format = "%V")) %>%
  relocate(c("Kalenderjahr", "Kalenderwoche", "Erkrankungsdatum", "Bundesland", "Altersgruppe", "Geschlecht", "Neuerkrankung"))

# 01.01.2021 bis 03.01.2021 gehoert zu 2020, Kalenderwoche 53
  inzidenz_erkrankungsbeginn_clean_new <- inzidenz_erkrankungsbeginn_clean %>%
    mutate(Kalenderjahr = replace(Kalenderjahr, Erkrankungsdatum == "2021-01-01", "2020")) %>%
    mutate(Kalenderjahr = replace(Kalenderjahr, Erkrankungsdatum == "2021-01-02", "2020")) %>%
    mutate(Kalenderjahr = replace(Kalenderjahr, Erkrankungsdatum == "2021-01-03", "2020")) %>%
  select(Kalenderjahr, Kalenderwoche, Bundesland, Altersgruppe, Geschlecht, Neuerkrankung) %>%
  group_by(Kalenderjahr, Kalenderwoche, Bundesland, Altersgruppe, Geschlecht) %>% 
  summarise(Neuerkrankung = sum(Neuerkrankung)) %>%
  ungroup()
```

changed inzidenz_erkrankungsbeginn_clean_new(final version of inzidenz_erkrankungsbeginn_clean_new)
```{r}
# 1. column "Geschlecht"
# 2. column "Geschlecht" veraendern: nur "00-59" und "60+"
# 3. "NA"-rows weg nehmen: es gibt 510 NAs.
# 4. filter Daten bis 2021/47
inzidenz_erkrankungsbeginn_final <-
  inzidenz_erkrankungsbeginn_clean_new %>%
  select(Kalenderjahr, Kalenderwoche, Bundesland, Altersgruppe, Neuerkrankung) %>%
  mutate(Altersgruppe = case_when(
    Altersgruppe == "00-04" ~ "00-59",
    Altersgruppe == "05-14" ~ "00-59",
    Altersgruppe == "15-34" ~ "00-59",
    Altersgruppe == "35-59" ~ "00-59",
    Altersgruppe == "60-79" ~ "60+",
    Altersgruppe == "80+" ~ "60+",
    TRUE ~ Altersgruppe
  )) %>%
  group_by(Kalenderjahr, Kalenderwoche, Bundesland, Altersgruppe) %>%
  summarise(Neuerkrankung = sum(Neuerkrankung)) %>%
  ungroup() %>%
  na.omit() %>%
  filter(!(Kalenderjahr == "2021" & Kalenderwoche > "47"))

```

Data "hospitalisierung" cleaning
```{r}
#summary(hospitalisierung)
# basierend auf alle Daten am Montag
hospitalisierung_clean <- 
  hospitalisierung %>%
  select(Datum, Bundesland, Altersgruppe, '7T_Hospitalisierung_Faelle') %>% 
  mutate(Berichtsdatum = as.Date(Datum)) %>%
  mutate(Weekday = as.factor(weekdays(Berichtsdatum, abbreviate = TRUE))) %>%
  filter(!(Bundesland == "Bundesgebiet" | Altersgruppe == "00+")) %>%
  filter(Weekday == "周一") %>% # "周一" bedeutet "Montag"
  mutate(Berichtsdatum = Berichtsdatum - 1) %>%
  arrange(-desc(Berichtsdatum)) %>%
  mutate(Kalenderjahr = format(Berichtsdatum, format = "%Y"),
         Kalenderwoche = strftime(Berichtsdatum, format = "%V")) %>%
  mutate(Kalenderjahr = replace(Kalenderjahr, Kalenderwoche == "53", "2020")) %>%
  select(Kalenderjahr, Kalenderwoche, Bundesland, Altersgruppe, '7T_Hospitalisierung_Faelle') %>%
  mutate(Bundesland = str_replace_all(Bundesland, "ü", "ue")) %>% 
  mutate(Bundesland = str_replace_all(Bundesland, "ä", "ae")) %>% 
  mutate(Bundesland = str_replace_all(Bundesland, "ö", "oe")) %>% 
  mutate(Bundesland = str_replace_all(Bundesland, "ß", "ss")) %>%
  select(Kalenderjahr, Kalenderwoche, Bundesland, Altersgruppe, '7T_Hospitalisierung_Faelle')

colnames(hospitalisierung_clean)[which(names(hospitalisierung_clean) == "7T_Hospitalisierung_Faelle")] <- "Hospitalisierung"  
```

untersuchen, ob Ergebnisse von "hospitalisierung_clean" gleich wie andere Daten von RKI sind(this chunk is not for Datensatz cleaning, just check, so when people don't have to run it, if they just want cleaned Datensatz)
```{r}
# basierend auf alle Daten am Sonntag
hospitalisierung_clean_sonn <- 
  hospitalisierung %>%
  select(Datum, Bundesland, Altersgruppe, '7T_Hospitalisierung_Faelle') %>% 
  mutate(Berichtsdatum = as.Date(Datum)) %>%
  mutate(Weekday = as.factor(weekdays(Berichtsdatum, abbreviate = TRUE))) %>%
  filter(!(Bundesland == "Bundesgebiet" | Altersgruppe == "00+")) %>%
  filter(Weekday == "周日") %>% # "周日" bedeutet "Sonntag"
  arrange(-desc(Berichtsdatum)) %>%
  mutate(Kalenderjahr = format(Berichtsdatum, format = "%Y"),
         Kalenderwoche = strftime(Berichtsdatum, format = "%V")) %>%
  mutate(Kalenderjahr = replace(Kalenderjahr, Kalenderwoche == "53", "2020")) %>%
  select(Kalenderjahr, Kalenderwoche, Bundesland, Altersgruppe, '7T_Hospitalisierung_Faelle') %>%
  mutate(Bundesland = str_replace_all(Bundesland, "ü", "ue")) %>% 
  mutate(Bundesland = str_replace_all(Bundesland, "ä", "ae")) %>% 
  mutate(Bundesland = str_replace_all(Bundesland, "ö", "oe")) %>% 
  mutate(Bundesland = str_replace_all(Bundesland, "ß", "ss")) %>%
  select(Kalenderjahr, Kalenderwoche, Bundesland, Altersgruppe, '7T_Hospitalisierung_Faelle')

# cheak insgesamt_hospitalisierung nach Zeit
hospitalisierung_test <- 
  hospitalisierung %>%
  select(Datum, Bundesland, Altersgruppe, '7T_Hospitalisierung_Faelle') %>% 
  mutate(Berichtsdatum = as.Date(Datum)) %>%
  mutate(Weekday = as.factor(weekdays(Berichtsdatum, abbreviate = TRUE))) %>%
  filter(Altersgruppe != "00+") %>%
  filter(Weekday == "周一") %>%
  mutate(Berichtsdatum = Berichtsdatum - 1) %>%
  filter(Bundesland == "Bundesgebiet") %>%
  arrange(-desc(Berichtsdatum)) %>%
  mutate(Kalenderjahr = format(Berichtsdatum, format = "%Y"),
         Kalenderwoche = strftime(Berichtsdatum, format = "%V")) %>%
  mutate(Kalenderjahr = replace(Kalenderjahr, Kalenderwoche == "53", "2020")) %>%
  select(Kalenderjahr, Kalenderwoche, Bundesland, Altersgruppe, '7T_Hospitalisierung_Faelle') # Daten sind ungefaehr gleich wie Faelle_Hosp_Alter.Rds 

hospitalisierung_test2 <-  
  hospitalisierung %>%
  select(Datum, Bundesland, Altersgruppe, '7T_Hospitalisierung_Faelle', '7T_Hospitalisierung_Inzidenz') %>% 
  mutate(Berichtsdatum = as.Date(Datum)) %>%
  mutate(Weekday = as.factor(weekdays(Berichtsdatum, abbreviate = TRUE))) %>%
  filter(Weekday == "周日" & Altersgruppe == "00+") %>%
  mutate(Berichtsdatum = Berichtsdatum - 1) %>%
  filter(Bundesland == "Bundesgebiet") %>%
  arrange(-desc(Berichtsdatum)) %>%
  mutate(Kalenderjahr = format(Berichtsdatum, format = "%Y"),
         Kalenderwoche = strftime(Berichtsdatum, format = "%V")) %>%
  mutate(Kalenderjahr = replace(Kalenderjahr, Kalenderwoche == "53", "2020")) %>%
  select(Kalenderjahr, Kalenderwoche, '7T_Hospitalisierung_Faelle')
colnames(hospitalisierung_test2)[which(names(hospitalisierung_test2) == "7T_Hospitalisierung_Faelle")] <- "Sonntag_hosp"

hospitalisierung_test3 <-  
  hospitalisierung %>%
  select(Datum, Bundesland, Altersgruppe, '7T_Hospitalisierung_Faelle', '7T_Hospitalisierung_Inzidenz') %>% 
  mutate(Berichtsdatum = as.Date(Datum)) %>%
  mutate(Weekday = as.factor(weekdays(Berichtsdatum, abbreviate = TRUE))) %>%
  filter(Weekday == "周一" & Altersgruppe == "00+") %>%
  mutate(Berichtsdatum = Berichtsdatum - 1) %>%
  filter(Bundesland == "Bundesgebiet") %>%
  arrange(-desc(Berichtsdatum)) %>%
  mutate(Kalenderjahr = format(Berichtsdatum, format = "%Y"),
         Kalenderwoche = strftime(Berichtsdatum, format = "%V")) %>%
  mutate(Kalenderjahr = replace(Kalenderjahr, Kalenderwoche == "53", "2020")) %>%
  select(Kalenderjahr, Kalenderwoche, '7T_Hospitalisierung_Faelle')
colnames(hospitalisierung_test3)[which(names(hospitalisierung_test3) == "7T_Hospitalisierung_Faelle")] <- "Montag_hosp"

# klinische_aspekte
check_hos <-
  klinische_aspekte %>%
  mutate(Kalenderjahr = Meldejahr,
         Kalenderwoche = MW) %>%
  select(Kalenderjahr, Kalenderwoche, `Anzahl hospitalisiert`)
colnames(check_hos)[which(names(check_hos) == "Anzahl hospitalisiert")] <- "check_hosp"

# vergleich klinische_aspekte
total1 <- merge(hospitalisierung_test2,hospitalisierung_test3,by=c("Kalenderjahr","Kalenderwoche"))
total2 <- merge(total1,check_hos,by=c("Kalenderjahr","Kalenderwoche"))
total3 <-
  total2 %>%
  mutate(sonn_check = Sonntag_hosp - check_hosp,
         mon_check = Montag_hosp - check_hosp)
# die Datensatz, die auf allen Daten am Montag, ist aehnlich wie andere Daten von RKI

# cheak hospitalisierung nach Zeit und Altergruppe
# vergleich Faelle_Hosp_Alter
Faelle_Hosp_Alter <- Faelle_Hosp_Alter[-1,]
colnames(Faelle_Hosp_Alter)[which(names(Faelle_Hosp_Alter) == "...1")] <- "Kalenderjahr"
colnames(Faelle_Hosp_Alter)[which(names(Faelle_Hosp_Alter) == "...2")] <- "Kalenderwoche"
colnames(Faelle_Hosp_Alter)[which(names(Faelle_Hosp_Alter) == "Fälle 0 - 4 Jährige")] <- "00-04"
colnames(Faelle_Hosp_Alter)[which(names(Faelle_Hosp_Alter) == "Fälle 5 - 14 Jährige")] <- "05-14"
colnames(Faelle_Hosp_Alter)[which(names(Faelle_Hosp_Alter) == "Fälle 15 - 34 Jährige")] <- "15-34"
colnames(Faelle_Hosp_Alter)[which(names(Faelle_Hosp_Alter) == "Fälle 35 - 59 Jährige
<chr>")] <- "35-59"
colnames(Faelle_Hosp_Alter)[which(names(Faelle_Hosp_Alter) == "Fälle 60 - 79 Jährige")] <- "60-79"
Faelle_Hosp_Alter_new <- gather(Faelle_Hosp_Alter, Altersgruppe, Alter_Hospitalisierung, "00-04":"60-79")
hospitalisierung_check <- hospitalisierung_clean %>%
  select(Kalenderjahr, Kalenderwoche, Altersgruppe, '7T_Hospitalisierung_Faelle') %>%
  group_by(Kalenderjahr, Kalenderwoche, Altersgruppe) %>%
  summarise(Hospitalisierung = sum(Hospitalisierung))
```

changed Data "hospitalisierung" cleaning(final version of hospitalisierung_clean)
```{r}
# 1. column "Geschlecht" veraendern: nur "00-59" und "60+"
# 2. "NA"-rows weg nehmen: es gibt 0 NAs.
# 3. filter Daten bis 2021/47
hospitalisierung_clean_final <-
  hospitalisierung_clean %>%
  select(Kalenderjahr, Kalenderwoche, Bundesland, Altersgruppe, Hospitalisierung) %>%
  mutate(Altersgruppe = case_when(
    Altersgruppe == "00-04" ~ "00-59",
    Altersgruppe == "05-14" ~ "00-59",
    Altersgruppe == "15-34" ~ "00-59",
    Altersgruppe == "35-59" ~ "00-59",
    Altersgruppe == "60-79" ~ "60+",
    Altersgruppe == "80+" ~ "60+",
    TRUE ~ Altersgruppe
  )) %>%
  group_by(Kalenderjahr, Kalenderwoche, Bundesland, Altersgruppe) %>%
  summarise(Hospitalisierung = sum(Hospitalisierung)) %>%
  ungroup() %>%
  na.omit() %>%
  filter(!(Kalenderjahr == "2021" & Kalenderwoche > "47"))
```

zusammenfassung inzidenz nach Anmeldedatum und Hospitalisierung
```{r}
final_nachAnmeldedatum <- merge(inzidenz_clean_final, hospitalisierung_clean_final, by = c("Kalenderjahr", "Kalenderwoche", "Bundesland", "Altersgruppe"), all = T)

# add season

final_nachAnmeldedatum2020 <-
  final_nachAnmeldedatum %>%
  filter(Kalenderjahr == "2020") %>%
  add_column(Jahreszeit = case_when(
.$Kalenderwoche == "01" | .$Kalenderwoche == "02" | .$Kalenderwoche == "03" | .$Kalenderwoche == "04" | .$Kalenderwoche == "05" ~ "Winter",
.$Kalenderwoche == "06" | .$Kalenderwoche == "07" | .$Kalenderwoche == "08" | .$Kalenderwoche == "09" | .$Kalenderwoche == "10" | .$Kalenderwoche == "11" | .$Kalenderwoche == "12" | .$Kalenderwoche == "13" | .$Kalenderwoche == "14" | .$Kalenderwoche == "15" | .$Kalenderwoche == "16" | .$Kalenderwoche == "17" | .$Kalenderwoche == "18" ~ "Fruehling",
.$Kalenderwoche == "19" | .$Kalenderwoche == "20" | .$Kalenderwoche == "21" | .$Kalenderwoche == "22" | .$Kalenderwoche == "23" | .$Kalenderwoche == "24" | .$Kalenderwoche == "25" | .$Kalenderwoche == "26" | .$Kalenderwoche == "27" | .$Kalenderwoche == "28" | .$Kalenderwoche == "29" | .$Kalenderwoche == "30" | .$Kalenderwoche == "31" ~ "Sommer",
.$Kalenderwoche == "32" | .$Kalenderwoche == "33" | .$Kalenderwoche == "34" | .$Kalenderwoche == "35" | .$Kalenderwoche == "36" | .$Kalenderwoche == "37" | .$Kalenderwoche == "38" | .$Kalenderwoche == "39" | .$Kalenderwoche == "40" | .$Kalenderwoche == "41" | .$Kalenderwoche == "42" | .$Kalenderwoche == "43" | .$Kalenderwoche == "44" ~ "Herbst",
.$Kalenderwoche =="45" | .$Kalenderwoche == "46" | .$Kalenderwoche == "47" | .$Kalenderwoche == "48" | .$Kalenderwoche == "49" | .$Kalenderwoche == "50" | .$Kalenderwoche == "51" | .$Kalenderwoche == "52" | .$Kalenderwoche == "53" ~ "Winter"))

final_nachAnmeldedatum2021 <-
  final_nachAnmeldedatum %>%
  filter(Kalenderjahr == "2021") %>%
  add_column(Jahreszeit = case_when(
.$Kalenderwoche == "01" | .$Kalenderwoche == "02" | .$Kalenderwoche == "03" | .$Kalenderwoche == "04" ~ "Winter",
.$Kalenderwoche == "05" | .$Kalenderwoche == "06" | .$Kalenderwoche == "07" | .$Kalenderwoche == "08" | .$Kalenderwoche == "09" | .$Kalenderwoche == "10" | .$Kalenderwoche == "11" | .$Kalenderwoche == "12" | .$Kalenderwoche == "13" | .$Kalenderwoche == "14" | .$Kalenderwoche == "15" | .$Kalenderwoche == "16" | .$Kalenderwoche == "17" ~ "Fruehling",
.$Kalenderwoche == "18" | .$Kalenderwoche == "19" | .$Kalenderwoche == "20" | .$Kalenderwoche == "21" | .$Kalenderwoche == "22" | .$Kalenderwoche == "23" | .$Kalenderwoche == "24" | .$Kalenderwoche == "25" | .$Kalenderwoche == "26" | .$Kalenderwoche == "27" | .$Kalenderwoche == "28" | .$Kalenderwoche == "29" | .$Kalenderwoche == "30"  ~ "Sommer",
.$Kalenderwoche == "31" | .$Kalenderwoche == "32" | .$Kalenderwoche == "33" | .$Kalenderwoche == "34" | .$Kalenderwoche == "35" | .$Kalenderwoche == "36" | .$Kalenderwoche == "37" | .$Kalenderwoche == "38" | .$Kalenderwoche == "39" | .$Kalenderwoche == "40" | .$Kalenderwoche == "41" | .$Kalenderwoche == "42" | .$Kalenderwoche == "43" ~ "Herbst",
.$Kalenderwoche == "44" | .$Kalenderwoche == "45" | .$Kalenderwoche == "46" | .$Kalenderwoche == "47" | .$Kalenderwoche == "48" | .$Kalenderwoche == "49" | .$Kalenderwoche == "50" | .$Kalenderwoche == "51" | .$Kalenderwoche == "52" ~ "Winter"))

final_nachAnmeldedatum <- rbind(final_nachAnmeldedatum2020, final_nachAnmeldedatum2021)

# ersetzen NA durch 0 in column "Hospitalisierung" und "Neuerkrankung"
final_nachAnmeldedatum <-
  final_nachAnmeldedatum %>%
  mutate(Hospitalisierung = if_else(is.na(Hospitalisierung), 0, Hospitalisierung),
         Neuerkrankung = if_else(is.na(Neuerkrankung), 0, Neuerkrankung))
```

Data "impfung" cleaning
```{r}
df_bundeslaender2 <- data.frame('Bundeslandnummer' = c("01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12", "13", "14", "15", "16", "17"), 
                                'Bundesland' = c("Schleswig-Holstein",
                                                      "Hamburg",
                                                      "Niedersachsen",
                                                      "Bremen",
                                                      "Nordrhein-Westfalen",
                                                      "Hessen",
                                                      "Rheinland-Pfalz",
                                                      "Baden-Wuerttemberg",
                                                      "Bayern",
                                                      "Saarland",
                                                      "Berlin",
                                                      "Brandenburg",
                                                      "Mecklenburg-Vorpommern",
                                                      "Sachsen",
                                                      "Sachen-Anhalt",
                                                      "Thueringen",
                                                 "Bundesressorts")
)
impfung_new <-
  impfung %>%
  mutate(IdLandkreis = as.character(LandkreisId_Impfort)) %>%
  mutate(Bundeslandnummer = gsub('.{3}$', '', LandkreisId_Impfort))

impfung_new <- dplyr::left_join(impfung_new, df_bundeslaender2, by = 'Bundeslandnummer')

# Clean the Daten
impfung_clean <- 
  impfung_new %>%
  select(Bundesland, Altersgruppe, Impfschutz, Impfanzahl = Anzahl, Impfdatum) %>% 
  mutate(Impfdatum = as.Date(Impfdatum)) %>%
  arrange(-desc(Impfdatum)) %>%
  group_by(Impfdatum, Bundesland, Altersgruppe, Impfschutz) %>%
  summarise(Impfanzahl = sum(Impfanzahl)) %>%
  ungroup() %>%
  filter(Impfdatum <= "2021-11-28")

# 14 Tage nach zweiter Impfung kann man vollstaendig schutzt werden.
impfung_vollstaendig <-
  impfung_clean %>%
  filter(Impfschutz == "2" | Impfschutz == "3") %>%
  mutate(Impfdatum = Impfdatum + 14)
impfung_teilweise <-
  impfung_clean %>%
  filter(Impfschutz == "1")
impfung_clean_new <- rbind(impfung_vollstaendig, impfung_teilweise)
impfung_clean_new <-
  impfung_clean_new %>%
  arrange(-desc(Impfdatum))

# in originale Daten gibt es nur die Anzahl von Impften nur fuer einen Tag, hier kann man die die Anzahl von Impften nur fuer diesen Tag und vorher wissen.
date_begin <- as.Date("2020-12-27")
date_end <- as.Date("2021-12-12")
df_new2 <- data.frame()
  for (datum in date_begin:date_end) {
  df_new <- 
  impfung_clean_new %>%
  filter(Impfdatum <= datum)
  #print(df_new)
  df_new <-
  df_new %>%
  add_column(add_Date = as.Date(datum, origin="1970-01-01")) %>%
  select(add_Date, Bundesland, Altersgruppe, Impfschutz, Impfanzahl) %>%
  group_by(add_Date, Bundesland, Altersgruppe, Impfschutz) %>%
  summarise(Impfanzahl = sum(Impfanzahl))
  #print(df_new)
  df_new2 <- rbind(df_new, df_new2)
  #print(df_new2)
  #print(datum)
}
impfung_clean_new_sum <-
  df_new2 %>%
  arrange(-desc(add_Date))

inzidenz_clean <- 
  inzidenz_new %>%
  select(Bundesland, Altersgruppe, Geschlecht, Neuerkrankung = AnzahlFall, Meldedatum) %>% 
  mutate(Meldedatum = as.Date(Meldedatum)) %>%
  mutate(Altersgruppe = str_remove_all(Altersgruppe, "A")) %>% 
  mutate(Altersgruppe = case_when(
    Altersgruppe == "unbekannt" ~ NA_character_,
    TRUE ~ Altersgruppe
  )) %>% 
  mutate(Geschlecht = case_when(
    Geschlecht == "unbekannt" ~ NA_character_,
    TRUE ~ Geschlecht
  )) %>% 
  arrange(-desc(Meldedatum)) %>%
  mutate(Kalenderjahr = format(Meldedatum, format = "%Y"),
         Kalenderwoche = strftime(Meldedatum, format = "%V")) %>%
  relocate(c("Kalenderjahr", "Kalenderwoche", "Meldedatum", "Bundesland", "Altersgruppe", "Geschlecht", "Neuerkrankung"))

  
# 01.01.2021 bis 03.01.2021 gehoert zu 2020, Kalenderwoche 53
  impfung_clean_new <-
    impfung_clean_new %>%
    mutate(Kalenderjahr = replace(Kalenderjahr, Impfdatum == "2021-01-01", "2020")) %>%
    mutate(Kalenderjahr = replace(Kalenderjahr, Impfdatum == "2021-01-02", "2020")) %>%
    mutate(Kalenderjahr = replace(Kalenderjahr, Impfdatum == "2021-01-03", "2020")) %>%
    select(Kalenderjahr, Kalenderwoche, Bundesland, Altersgruppe, Impfschutz, Impfanzahl) %>%
  group_by(Kalenderjahr, Kalenderwoche, Bundesland, Altersgruppe, Impfschutz) %>% 
  summarise(Impfanzahl = sum(Impfanzahl)) %>%
  ungroup()
  
```


